<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio 6.20.5 / JasperReports 6.20.5 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
    name="proyecto_tareas_materiales"
    pageWidth="595" pageHeight="842" columnWidth="515"
    leftMargin="40" rightMargin="40" topMargin="50" bottomMargin="50"
    uuid="99a5f867-39eb-42a5-add6-db00ab1c5142">

    <!-- ===================== -->
    <!--      ESTILOS GLOBALES -->
    <!-- ===================== -->
    <style name="Base" fontName="SansSerif" fontSize="10" forecolor="#111827"/>
    <style name="TituloPrincipal" style="Base" fontSize="18" isBold="true" forecolor="#111827"/>
    <style name="Subtitulo" style="Base" fontSize="12" forecolor="#374151"/>
    <style name="Etiqueta" style="Base" isBold="true" forecolor="#111827"/>
    <style name="Valor" style="Base" forecolor="#111827"/>
    <style name="TablaCabecera" style="Base" isBold="true" backcolor="#F3F4F6" mode="Opaque" forecolor="#111827"/>
    <style name="TotalLabel" style="Base" isBold="true" forecolor="#111827"/>
    <style name="TotalValue" style="Base" isBold="true" forecolor="#111827"/>

    <!-- Parámetro -->
    <parameter name="idProyecto" class="java.lang.Long"/>

    <!-- ===================== -->
    <!--        CONSULTA SQL   -->
    <!-- ===================== -->
    <queryString>
        <![CDATA[
            SELECT 
                p.id AS proyecto_id,
                p.nombre AS proyecto_nombre,
                p.descripcion AS proyecto_descripcion,
                p.fecha_ini AS proyecto_fecha_ini,
                p.fecha_fin AS proyecto_fecha_fin,
                p.estado AS proyecto_estado,
                p.margen_beneficio AS proyecto_margen,

                t.id AS tarea_id,
                t.nombre AS tarea_nombre,
                t.descripcion AS tarea_descripcion,
                t.fecha_ini AS tarea_fecha_ini,
                t.fecha_fin AS tarea_fecha_fin,
                t.estado AS tarea_estado,
                t.horas_estimadas AS tarea_horas,
                t.obseraciones AS tarea_observaciones,
                t.tipo AS tarea_tipo,

                m.id AS material_id,
                m.nombre AS material_nombre,
                m.referencia AS material_referencia,
                m.precio_unitario AS material_precio_unitario,

                tm.cantidad AS material_cantidad,
                (tm.cantidad * m.precio_unitario) AS material_total

            FROM proyectos p
            LEFT JOIN tareas t ON t.id_proyecto = p.id
            LEFT JOIN tareas_material tm ON tm.id_tarea = t.id
            LEFT JOIN materiales m ON m.id = tm.id_material

            WHERE p.id = $P{idProyecto}

            ORDER BY t.id, m.nombre
        ]]>
    </queryString>

    <!-- ===================== -->
    <!--         CAMPOS        -->
    <!-- ===================== -->
    <field name="proyecto_nombre" class="java.lang.String"/>
    <field name="proyecto_descripcion" class="java.lang.String"/>
    <field name="proyecto_fecha_ini" class="java.sql.Date"/>
    <field name="proyecto_fecha_fin" class="java.sql.Date"/>
    <field name="proyecto_estado" class="java.lang.String"/>
    <field name="proyecto_margen" class="java.math.BigDecimal"/>

    <field name="tarea_id" class="java.lang.Long"/>
    <field name="tarea_nombre" class="java.lang.String"/>
    <field name="tarea_descripcion" class="java.lang.String"/>
    <field name="tarea_fecha_ini" class="java.sql.Date"/>
    <field name="tarea_fecha_fin" class="java.sql.Date"/>
    <field name="tarea_estado" class="java.lang.String"/>

    <field name="material_nombre" class="java.lang.String"/>
    <field name="material_referencia" class="java.lang.String"/>
    <field name="material_precio_unitario" class="java.math.BigDecimal"/>
    <field name="material_cantidad" class="java.lang.Integer"/>
    <field name="material_total" class="java.math.BigDecimal"/>

    <!-- ===================== -->
    <!--       VARIABLES       -->
    <!-- ===================== -->
    <variable name="totalTarea" class="java.math.BigDecimal" resetType="Group" resetGroup="GrupoTarea" calculation="Sum">
        <variableExpression><![CDATA[$F{material_total}]]></variableExpression>
    </variable>

    <variable name="totalProyecto" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$F{material_total}]]></variableExpression>
    </variable>

    <variable name="beneficioProyecto" class="java.math.BigDecimal">
        <variableExpression><![CDATA[
            ($V{totalProyecto} != null && $F{proyecto_margen} != null)
                ? $V{totalProyecto}.multiply( $F{proyecto_margen}.divide(new java.math.BigDecimal(100)) )
                : new java.math.BigDecimal(0)
        ]]></variableExpression>
    </variable>

    <variable name="totalConBeneficio" class="java.math.BigDecimal">
        <variableExpression><![CDATA[
            ($V{totalProyecto} != null && $V{beneficioProyecto} != null)
                ? $V{totalProyecto}.add($V{beneficioProyecto})
                : new java.math.BigDecimal(0)
        ]]></variableExpression>
    </variable>

    <!-- ===================== -->
    <!--         GRUPO         -->
    <!-- ===================== -->
    <group name="GrupoTarea">
        <groupExpression><![CDATA[$F{tarea_id}]]></groupExpression>

        <groupHeader>
            <band height="84">
                <!-- Fondo del header del grupo -->
                <rectangle>
                    <reportElement x="0" y="0" width="515" height="80" backcolor="#EEF2FF" mode="Opaque"/>
                </rectangle>

                <textField style="TituloPrincipal">
                    <reportElement x="10" y="6" width="495" height="22"/>
                    <textElement textAlignment="Left"/>
                    <textFieldExpression><![CDATA["Tarea: " + $F{tarea_nombre}]]></textFieldExpression>
                </textField>

                <textField style="Valor">
                    <reportElement x="10" y="30" width="495" height="16"/>
                    <textElement textAlignment="Left"/>
                    <textFieldExpression><![CDATA["Estado: " + $F{tarea_estado}]]></textFieldExpression>
                </textField>

                <!-- Fechas (si quieres patrón dd/MM/yyyy te lo preparo) -->
                <textField style="Valor">
                    <reportElement x="10" y="48" width="240" height="16"/>
                    <textElement textAlignment="Left"/>
                    <textFieldExpression><![CDATA["Inicio: " + $F{tarea_fecha_ini}]]></textFieldExpression>
                </textField>

                <textField style="Valor">
                    <reportElement x="265" y="48" width="240" height="16"/>
                    <textElement textAlignment="Left"/>
                    <textFieldExpression><![CDATA["Fin: " + $F{tarea_fecha_fin}]]></textFieldExpression>
                </textField>

                <!-- Separador inferior -->
                <line>
                    <reportElement x="0" y="80" width="515" height="1" forecolor="#CBD5E1"/>
                </line>
            </band>
        </groupHeader>

        <groupFooter>
            <band height="28">
                <line>
                    <reportElement x="0" y="2" width="515" height="1" forecolor="#E5E7EB"/>
                </line>

                <staticText style="TotalLabel">
                    <reportElement x="300" y="6" width="100" height="18"/>
                    <textElement textAlignment="Right"/>
                    <text><![CDATA[Total tarea:]]></text>
                </staticText>

                <textField style="TotalValue" pattern="#,##0.00 €">
                    <reportElement x="400" y="6" width="115" height="18"/>
                    <textElement textAlignment="Right"/>
                    <textFieldExpression><![CDATA[$V{totalTarea}]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>

    <!-- ===================== -->
    <!--         TÍTULO        -->
    <!-- ===================== -->
    <title>
        <band height="104">
            <textField style="TituloPrincipal">
                <reportElement x="0" y="0" width="515" height="28"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["Proyecto: " + $F{proyecto_nombre}]]></textFieldExpression>
            </textField>

            <textField style="Subtitulo">
                <reportElement x="0" y="30" width="515" height="18"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[$F{proyecto_descripcion}]]></textFieldExpression>
            </textField>

            <textField style="Valor">
                <reportElement x="0" y="54" width="240" height="16"/>
                <textElement textAlignment="Left"/>
                <textFieldExpression><![CDATA["Estado: " + $F{proyecto_estado}]]></textFieldExpression>
            </textField>

            <textField style="Valor">
                <reportElement x="260" y="54" width="240" height="16"/>
                <textElement textAlignment="Left"/>
                <textFieldExpression><![CDATA["Margen beneficio: " + $F{proyecto_margen} + "%"]]></textFieldExpression>
            </textField>

            <line>
                <reportElement x="0" y="82" width="515" height="1" forecolor="#E5E7EB"/>
            </line>
        </band>
    </title>

    <!-- ===================== -->
    <!--   CABECERA DE COLUMNA -->
    <!-- ===================== -->
    <columnHeader>
        <band height="22">
            <staticText style="TablaCabecera">
                <reportElement x="0" y="2" width="180" height="18"/>
                <textElement textAlignment="Left" verticalAlignment="Middle"/>
                <text><![CDATA[Material]]></text>
            </staticText>

            <staticText style="TablaCabecera">
                <reportElement x="180" y="2" width="140" height="18"/>
                <textElement textAlignment="Left" verticalAlignment="Middle"/>
                <text><![CDATA[Referencia]]></text>
            </staticText>

            <staticText style="TablaCabecera">
                <reportElement x="320" y="2" width="60" height="18"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <text><![CDATA[Cantidad]]></text>
            </staticText>

            <staticText style="TablaCabecera">
                <reportElement x="380" y="2" width="70" height="18"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <text><![CDATA[Precio]]></text>
            </staticText>

            <staticText style="TablaCabecera">
                <reportElement x="450" y="2" width="65" height="18"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <text><![CDATA[Total]]></text>
            </staticText>
        </band>
    </columnHeader>

    <!-- ===================== -->
    <!--        DETALLE        -->
    <!-- ===================== -->
    <detail>
        <band height="18">
            <!-- Zebra row (fondo en filas pares) -->
            <rectangle>
                <reportElement x="-1" y="0" width="517" height="18" backcolor="#FAFAFA" mode="Opaque">
                    <printWhenExpression><![CDATA[$V{REPORT_COUNT} % 2 == 0]]></printWhenExpression>
                </reportElement>
            </rectangle>

            <textField style="Valor">
                <reportElement x="0" y="1" width="180" height="16"/>
                <textElement textAlignment="Left" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{material_nombre}]]></textFieldExpression>
            </textField>

            <textField style="Valor">
                <reportElement x="180" y="1" width="140" height="16"/>
                <textElement textAlignment="Left" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{material_referencia}]]></textFieldExpression>
            </textField>

            <textField style="Valor">
                <reportElement x="320" y="1" width="60" height="16"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{material_cantidad}]]></textFieldExpression>
            </textField>

            <textField style="Valor" pattern="#,##0.00 €">
                <reportElement x="380" y="1" width="70" height="16"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{material_precio_unitario}]]></textFieldExpression>
            </textField>

            <textField style="Valor" pattern="#,##0.00 €">
                <reportElement x="450" y="1" width="65" height="16"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{material_total}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <!-- ===================== -->
    <!--        RESUMEN        -->
    <!-- ===================== -->
    <summary>
        <band height="78">
            <line>
                <reportElement x="0" y="2" width="515" height="1" forecolor="#CBD5E1"/>
            </line>

            <staticText style="TotalLabel">
                <reportElement x="300" y="10" width="100" height="18"/>
                <textElement textAlignment="Right"/>
                <text><![CDATA[Total proyecto:]]></text>
            </staticText>
            <textField style="TotalValue" pattern="#,##0.00 €">
                <reportElement x="400" y="10" width="115" height="18"/>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA[$V{totalProyecto}]]></textFieldExpression>
            </textField>

            <staticText style="TotalLabel">
                <reportElement x="300" y="30" width="100" height="18"/>
                <textElement textAlignment="Right"/>
                <text><![CDATA[Beneficio:]]></text>
            </staticText>
            <textField style="TotalValue" pattern="#,##0.00 €">
                <reportElement x="400" y="30" width="115" height="18"/>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA[$V{beneficioProyecto}]]></textFieldExpression>
            </textField>

            <staticText style="TotalLabel">
                <reportElement x="300" y="50" width="100" height="18"/>
                <textElement textAlignment="Right"/>
                <text><![CDATA[Total final:]]></text>
            </staticText>
            <textField style="TotalValue" pattern="#,##0.00 €">
                <reportElement x="400" y="50" width="115" height="18"/>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA[$V{totalConBeneficio}]]></textFieldExpression>
            </textField>
        </band>
    </summary>

</jasperReport>